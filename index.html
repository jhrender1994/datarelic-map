<index.html>
<html>
<head>
    <title>TeamDesk Map Tool</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <style>
        body { font-family: sans-serif; margin: 0; padding: 10px; overflow: hidden; }
        #map { height: 500px; width: 100%; border-radius: 8px; border: 1px solid #ccc; }
        .controls { margin-top: 15px; display: flex; gap: 10px; align-items: center; }
        #save-btn { padding: 10px 20px; background: #28a745; color: white; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; }
        #save-btn:disabled { background: #ccc; cursor: not-allowed; }
        #polygon-name { padding: 10px; border: 1px solid #ccc; border-radius: 4px; width: 250px; }
    </style>
</head>
<body>

    <div id="map"></div>
    <div class="controls">
        <input type="text" id="polygon-name" placeholder="Name this area (e.g. North Field)..." />
        <button id="save-btn">Save to DataRelic</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-geometryutil@0.10.3/src/leaflet.geometryutil.min.js"></script>
    
    <script>
        // 1. Get Record ID from the URL (passed by TeamDesk)
        const urlParams = new URLSearchParams(window.location.search);
        const RECORD_ID = urlParams.get('recordId');

        // 2. Configuration
        const TEAMDESK_API_TOKEN = "853579C2326B4FE6A9B2D7BC49E266B2"; 
        const DB_ID = "89329"; 
        const TABLE_NAME = "blocks"; 

        // 3. Map Setup
        var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' });
        var map = L.map('map', { center: [0, 0], zoom: 2, layers: [satellite] });
        map.locate({setView: true, maxZoom: 16});

        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        
        var drawControl = new L.Control.Draw({
            edit: { featureGroup: drawnItems },
            draw: { 
                polygon: { allowIntersection: false, showArea: true, shapeOptions: { color: '#28a745' } }, 
                polyline: false, rectangle: false, circle: false, marker: false, circlemarker: false 
            }
        });
        map.addControl(drawControl);

        var currentAreaHectares = 0;

        map.on(L.Draw.Event.CREATED, function (event) {
            drawnItems.clearLayers(); 
            var layer = event.layer;
            drawnItems.addLayer(layer);
            var sqm = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
            currentAreaHectares = (sqm / 10000).toFixed(2);
            layer.bindPopup("<b>" + currentAreaHectares + " Hectares</b>").openPopup();
        });

        // 4. Save Logic
        document.getElementById('save-btn').onclick = async function() {
            var data = drawnItems.toGeoJSON();
            var name = document.getElementById('polygon-name').value;

            if (!RECORD_ID) { alert("Error: No Record ID found in URL."); return; }
            if (data.features.length === 0 || !name) { alert("Please draw a polygon and provide a name."); return; }

            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;
            saveBtn.innerText = "Saving...";

            const payload = {
                "Id": RECORD_ID, 
                "Area Name": name,
                "Hectares": currentAreaHectares,
                "Coordinates": JSON.stringify(data.features[0].geometry.coordinates)
            };

            try {
                const apiUrl = "https://www.app.datarelic.co.za/api/v2/" + DB_ID + "/" + TEAMDESK_API_TOKEN + "/" + TABLE_NAME + "/update.json";
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    alert("✅ Successfully saved!");
                } else {
                    alert("❌ Server Error: Check table/column names.");
                }
            } catch (err) {
                alert("❌ Connection failed.");
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerText = "Save to DataRelic";
            }
        };
    </script>
</body>
</html>

