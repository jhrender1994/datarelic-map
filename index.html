<!DOCTYPE html>
<html>
<head>
    <title>DataRelic Map Tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <style>
        body { font-family: sans-serif; margin: 0; padding: 10px; background: #f4f4f4; }
        #map { height: 500px; width: 100%; border-radius: 8px; border: 2px solid #ccc; background: #e0e0e0; }
        .controls { margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap; }
        button { padding: 12px 20px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; color: white; }
        #save-btn { background: #28a745; }
        #locate-btn { background: #007bff; }
        #polygon-name { padding: 12px; border: 1px solid #ccc; border-radius: 4px; flex-grow: 1; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="controls">
        <input type="text" id="polygon-name" placeholder="Name this area...">
        <button id="locate-btn" type="button">üìç Find My Location</button>
        <button id="save-btn" type="button">Save to DataRelic</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-geometryutil@0.10.3/src/leaflet.geometryutil.min.js"></script>
    
    <script>
        // NEW ENDPOINT APPLIED
        const WEBHOOK_URL = "https://www.app.datarelic.co.za/secure/db/89329/hooks/orfjgabz";
        
        const urlParams = new URLSearchParams(window.location.search);
        
        // This cleaning logic removes quotes, commas, and brackets sent by the formula error
        let rawId = urlParams.get('recordId') || "";
        const RECORD_ID = rawId.replace(/[\[\]"', ]/g, '');

        var map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' }).addTo(map);

        document.getElementById('locate-btn').onclick = function() { map.locate({setView: true, maxZoom: 16}); };
        
        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        var drawControl = new L.Control.Draw({
            draw: { polygon: true, polyline: false, rectangle: false, circle: false, marker: false }
        });
        map.addControl(drawControl);

        var areaSize = 0;
        map.on(L.Draw.Event.CREATED, function (e) {
            drawnItems.clearLayers();
            var layer = e.layer;
            drawnItems.addLayer(layer);
            var sqm = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
            areaSize = (sqm / 10000).toFixed(2);
            layer.bindPopup(areaSize + " Hectares").openPopup();
        });

        document.getElementById('save-btn').onclick = function() {
            var name = document.getElementById('polygon-name').value;
            
            // DEBUG ALERT: This helps you see if the ID is clean
            if (!RECORD_ID) {
                alert("ERROR: No Record ID found in the URL. Check your TeamDesk Dashboard formula.");
                return;
            }

            if (drawnItems.getLayers().length === 0 || !name) {
                alert("Missing Name or Drawing!");
                return;
            }

            var coords = drawnItems.toGeoJSON().features[0].geometry.coordinates;
            var formData = new FormData();
            formData.append('recordId', RECORD_ID);
            formData.append('areaName', name);
            formData.append('hectares', areaSize);
            formData.append('coordinates', JSON.stringify(coords));

            fetch(WEBHOOK_URL, { method: 'POST', mode: 'no-cors', body: formData })
                .then(() => alert("‚úÖ Data Sent for Record ID: " + RECORD_ID + ". Please refresh your TeamDesk page."))
                .catch(() => alert("‚ùå Connection Error"));
        };
    </script>
</body>
</html>
