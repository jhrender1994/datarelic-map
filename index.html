<!DOCTYPE html>
<html>
<head>
    <title>TeamDesk Map Tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <style>
        body { font-family: sans-serif; margin: 0; padding: 10px; background: #eee; }
        #map { height: 500px; width: 100%; border-radius: 8px; border: 2px solid #ccc; background: #ddd; }
        .controls { margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap; }
        button { padding: 12px 20px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; min-width: 150px; }
        #save-btn { background: #28a745; color: white; }
        #locate-btn { background: #007bff; color: white; }
        #polygon-name { padding: 12px; border: 1px solid #ccc; border-radius: 4px; flex-grow: 1; font-size: 16px; }
    </style>
</head>
<body>

    <div id="map"></div>
    <div class="controls">
        <input type="text" id="polygon-name" placeholder="Enter Area Name (e.g. Block A)">
        <button id="locate-btn">üìç Find My Location</button>
        <button id="save-btn">Save to DataRelic</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-geometryutil@0.10.3/src/leaflet.geometryutil.min.js"></script>
    
    <script>
        // Ensure script runs after page is fully loaded
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const RECORD_ID = urlParams.get('recordId');
            const WEBHOOK_URL = "https://www.app.datarelic.co.za/secure/db/89329/hooks/y7rkz4k3";

            // 1. Initialize Map with ESRI Satellite (Very Reliable)
            var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri'
            });

            var map = L.map('map', {
                center: [0, 0],
                zoom: 2,
                layers: [satellite]
            });

            // 2. Locate Me Logic
            document.getElementById('locate-btn').onclick = function() {
                this.innerText = "‚åõ Locating...";
                map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
            };

            map.on('locationfound', function(e) {
                document.getElementById('locate-btn').innerText = "üìç Find My Location";
                L.marker(e.latlng).addTo(map).bindPopup("You are here").openPopup();
            });

            map.on('locationerror', function() {
                document.getElementById('locate-btn').innerText = "üìç Find My Location";
                alert("Could not find your location. Please check GPS settings.");
            });

            // 3. Drawing Logic
            var drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
            var drawControl = new L.Control.Draw({
                edit: { featureGroup: drawnItems },
                draw: { 
                    polygon: { allowIntersection: false, showArea: true, shapeOptions: { color: '#28a745' } }, 
                    polyline: false, rectangle: false, circle: false, marker: false, circlemarker: false 
                }
            });
            map.addControl(drawControl);

            var currentAreaHectares = 0;
            map.on(L.Draw.Event.CREATED, function (event) {
                drawnItems.clearLayers(); 
                var layer = event.layer;
                drawnItems.addLayer(layer);
                var sqm = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
                currentAreaHectares = (sqm / 10000).toFixed(2);
                layer.bindPopup("<b>" + currentAreaHectares + " Hectares</b>").openPopup();
            });

            // 4. Save Logic
            document.getElementById('save-btn').onclick = async function() {
                var data = drawnItems.toGeoJSON();
                var name = document.getElementById('polygon-name').value;
                
                if (!RECORD_ID || data.features.length === 0 || !name) {
                    alert("Draw an area and enter a name first!");
                    return;
                }

                const saveBtn = document.getElementById('save-btn');
                saveBtn.innerText = "Saving...";
                saveBtn.disabled = true;

                const formData = new FormData();
                formData.append('recordId', RECORD_ID);
                formData.append('areaName', name);
                formData.append('hectares', currentAreaHectares);
                formData.append('coordinates', JSON.stringify(data.features[0].geometry.coordinates));

                try {
                    await fetch(WEBHOOK_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: formData
                    });
                    alert("‚úÖ Sent to TeamDesk! Please refresh the record.");
                } catch (err) {
                    alert("‚ùå Failed to send. Check internet.");
                } finally {
                    saveBtn.innerText = "Save to DataRelic";
                    saveBtn.disabled = false;
                }
            };
        };
    </script>
</body>
</html>
