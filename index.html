<!DOCTYPE html>
<html>
<head>
    <title>TeamDesk Map Tool</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <style>
        body { font-family: sans-serif; margin: 0; padding: 10px; }
        #map { height: 500px; width: 100%; border-radius: 8px; border: 1px solid #ccc; }
        .controls { margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap; }
        button { padding: 10px 15px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
        #save-btn { background: #28a745; color: white; }
        #locate-btn { background: #007bff; color: white; }
        #polygon-name { padding: 10px; border: 1px solid #ccc; border-radius: 4px; flex-grow: 1; }
    </style>
</head>
<body>

    <div id="map"></div>
    <div class="controls">
        <input type="text" id="polygon-name" placeholder="Name this area..." />
        <button id="locate-btn" type="button">üìç Find My Location</button>
        <button id="save-btn" type="button">Save to DataRelic</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-geometryutil@0.10.3/src/leaflet.geometryutil.min.js"></script>
    
    <script>
        const urlParams = new URLSearchParams(window.location.search);
    const RECORD_ID = urlParams.get('recordId');
    const TEAMDESK_API_TOKEN = "853579C2326B4FE6A9B2D7BC49E266B2"; 
    const DB_ID = "89329"; 
    const TABLE_NAME = "blocks"; 

    var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' });
    var map = L.map('map', { center: [0, 0], zoom: 2, layers: [satellite] });

    // Locate function with high accuracy settings
    document.getElementById('locate-btn').onclick = function() {
        this.innerText = "‚åõ Finding you...";
        this.style.background = "#ffa500";
        
        map.locate({
            setView: true, 
            maxZoom: 16,
            enableHighAccuracy: true,
            timeout: 10000 // 10 seconds timeout
        });
    };

    // This triggers when location is found
    map.on('locationfound', function(e) {
        document.getElementById('locate-btn').innerText = "üìç Find My Location";
        document.getElementById('locate-btn').style.background = "#007bff";
        
        // Remove old markers if they exist
        map.eachLayer(function (layer) {
            if (layer instanceof L.Marker && layer.options.title === "current_pos") {
                map.removeLayer(layer);
            }
        });

        var radius = e.accuracy / 2;
        L.marker(e.latlng, {title: "current_pos"}).addTo(map)
            .bindPopup("You are within " + radius.toFixed(0) + " meters of this point").openPopup();
        
        // Force the zoom
        map.setView(e.latlng, 16);
    });

    // This triggers if there is an error
    map.on('locationerror', function(e) {
        document.getElementById('locate-btn').innerText = "üìç Find My Location";
        document.getElementById('locate-btn').style.background = "#007bff";
        alert("Location error: " + e.message + ". Please ensure GPS is on and you are not in a basement/thick building.");
    });

    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    
    var drawControl = new L.Control.Draw({
        edit: { featureGroup: drawnItems },
        draw: { 
            polygon: { allowIntersection: false, showArea: true, shapeOptions: { color: '#28a745' } }, 
            polyline: false, rectangle: false, circle: false, marker: false, circlemarker: false 
        }
    });
    map.addControl(drawControl);

    var currentAreaHectares = 0;
    map.on(L.Draw.Event.CREATED, function (event) {
        drawnItems.clearLayers(); 
        var layer = event.layer;
        drawnItems.addLayer(layer);
        var sqm = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
        currentAreaHectares = (sqm / 10000).toFixed(2);
        layer.bindPopup("<b>" + currentAreaHectares + " Hectares</b>").openPopup();
    });

    document.getElementById('save-btn').onclick = async function() {
        var data = drawnItems.toGeoJSON();
        var name = document.getElementById('polygon-name').value;
        if (!RECORD_ID || data.features.length === 0 || !name) {
            alert("Ensure you draw a polygon, name it, and have a valid Record ID.");
            return;
        }
        const payload = { "Id": RECORD_ID, "Area Name": name, "Hectares": currentAreaHectares, "Coordinates": JSON.stringify(data.features[0].geometry.coordinates) };
        try {
            const response = await fetch("https://www.app.datarelic.co.za/api/v2/" + DB_ID + "/" + TEAMDESK_API_TOKEN + "/" + TABLE_NAME + "/update.json", {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            if (response.ok) alert("‚úÖ Saved!"); else alert("‚ùå Error saving.");
        } catch (err) { alert("‚ùå Connection failed."); }
    };
    </script>
</body>
</html>

